<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HairFix Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 
      UPDATE: Upgraded from Firebase V8 to V9 'compat' libraries.
      This gives us the modern V9 backend while maintaining 100% compatibility 
      with the existing V8 syntax (e.g., firebase.firestore()).
    -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CORE MODULES (Explicitly assigned from the global React object) ---
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useCallback = React.useCallback;
        const useMemo = React.useMemo;
        const memo = React.memo;

        // --- ENVIRONMENT VARIABLES (Accessing runtime provided configuration) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // Initialize App (This uses V8/Compat syntax)
        let firebaseApp;
        let auth;
        let firestore;

        if (firebaseConfig) {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                firestore = firebase.firestore();
                
                // V9 Compat syntax for settings is slightly different but V8 works
                try {
                    firestore.settings({ cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED });
                    firestore.enablePersistence().catch(err => console.log("Firestore persistence not supported or enabled."));
                } catch (e) {
                    console.warn("Could not set persistence:", e.message);
                }

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // The App component will handle the error message display
            }
        } else {
            console.error("Firebase config not available. Check environment variables.");
        }
        
        // --- FIREBASE V8 ACCESS FUNCTIONS ---
        // V8 uses dot notation and global objects instead of V9 modular functions
        const V8_COLLECTIONS = {
            users: `artifacts/${appId}/public/data/users`,
            inventory: `artifacts/${appId}/public/data/inventory_stock`,
            branchStock: `artifacts/${appId}/public/data/branch_ledger`,
            requests: `artifacts/${appId}/public/data/consumption_requests`,
            mainWarehouseStock: `artifacts/${appId}/public/data/main_warehouse_stock_ledger`,
            transferHistory: `artifacts/${appId}/public/data/transfer_history_ledger`,
        };

        const WHOLESALE_BRANCH_ID = 'WHOLESALE_CLIENTS';
        const MAIN_WAREHOUSE_ID = 'MAIN_WAREHOUSE';

        // Utility function to generate a human-readable product name
        const getProductNameDisplay = (item) => {
            if (!item) return "Unknown Product";
            return `${item.company} ${item.productName} (${item.size})`;
        };

        // Component for a styled button
        const Button = ({ onClick, children, className = 'bg-indigo-600 hover:bg-indigo-700', type = 'button', disabled = false }) => (
            <button
                onClick={onClick}
                type={type}
                disabled={disabled}
                className={`px-4 py-2 text-sm font-medium text-white rounded-lg shadow-md transition duration-150 ease-in-out 
                    ${className} 
                    ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
                `}
            >
                {children}
            </button>
        );

        // --- MAIN APP COMPONENT ---
        const App = () => {
            // --- FIREBASE AND AUTH STATE ---
            const [db, setDb] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [role, setRole] = useState(null); // 'Admin' or 'Staff'
            const [branchId, setBranchId] = useState(null); // e.g., 'Branch_01'
            const [isLoading, setIsLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');

            // --- APPLICATION DATA STATES ---
            const [allInventory, setAllInventory] = useState([]); 
            const [branchStock, setBranchStock] = useState({}); 
            const [mainWarehouseStock, setMainWarehouseStock] = useState({}); 
            const [requests, setRequests] = useState([]); 
            const [allUsers, setAllUsers] = useState([]); 
            const [transferHistory, setTransferHistory] = useState([]); 

            // 1. Firebase Initialization and Auth
            useEffect(() => {
                if (!firebaseApp || !firestore || !auth) {
                    setErrorMessage("Firebase initialization failed. Please check your config object in the HTML file.");
                    setIsLoading(false);
                    return;
                }
                setDb(firestore);

                try {
                    // Handle Authentication and Role setup
                    const setupAuth = async () => {
                        if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken)
                                .catch(err => {
                                    console.error("Custom token sign-in failed:", err);
                                    auth.signInAnonymously(); 
                                });
                        } else {
                            await auth.signInAnonymously();
                        }
                    };

                    setupAuth();

                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            setCurrentUser(user);
                            
                            // Fetch user role (V8 syntax)
                            // NOTE: We use user.uid as the document ID for the users collection
                            firestore.collection(V8_COLLECTIONS.users).doc(user.uid).onSnapshot((docSnap) => {
                                if (docSnap.exists) {
                                    const userData = docSnap.data();
                                    setRole(userData.role);
                                    setBranchId(userData.branchId || null);
                                    setIsLoading(false);
                                } else {
                                    setRole(null); 
                                    setBranchId(null);
                                    setIsLoading(false);
                                    console.warn("User role document not found. Assuming Admin for initial setup/demo.");
                                    // Good fallback for demo: set first user to Admin
                                    setRole("Admin"); 
                                }
                            }, (error) => {
                                console.error("Error reading user role:", error);
                                setErrorMessage("Permission Denied: Failed to load user role. Please check Firestore Security Rules for the Users collection.");
                                // Fallback for demo if rules are misconfigured
                                setRole("Admin");
                                setBranchId(null);
                                setIsLoading(false);
                            });
                        } else {
                            setCurrentUser(null);
                            setRole(null);
                            setBranchId(null);
                            setIsLoading(false);
                        }
                    });

                    return () => unsubscribe();
                } catch (error) {
                    console.error("Authentication setup failed:", error);
                    setErrorMessage("Authentication setup failed.");
                    setIsLoading(false);
                }
            }, []);

            // 2. Data Subscriptions (Run after DB/Auth is ready)
            useEffect(() => {
                if (!db || !currentUser || !role) return;

                // Inventory Subscription (V8 syntax)
                const unsubInventory = db.collection(V8_COLLECTIONS.inventory).onSnapshot((snapshot) => {
                    const inventoryList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAllInventory(inventoryList);
                }, (error) => console.error("Error fetching inventory:", error));

                // Requests Subscription 
                let requestsQuery = db.collection(V8_COLLECTIONS.requests);
                if (role === 'Staff' && branchId) {
                    requestsQuery = requestsQuery.where('branchId', '==', branchId);
                } 
                
                const unsubRequests = requestsQuery.onSnapshot((snapshot) => {
                    const requestsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    requestsList.sort((a, b) => {
                        if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                        if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                        // Sort by timestamp descending
                        const tsA = a.requestTimestamp?.seconds || a.requestTimestamp / 1000 || 0;
                        const tsB = b.requestTimestamp?.seconds || b.requestTimestamp / 1000 || 0;
                        return tsB - tsA;
                    });
                    setRequests(requestsList);
                }, (error) => console.error("Error fetching requests:", error));

                // Branch Stock Subscription 
                let unsubBranchStock = () => {};
                if (role === 'Staff' && branchId) {
                    const stockQuery = db.collection(V8_COLLECTIONS.branchStock).where('branchId', '==', branchId);
                    unsubBranchStock = stockQuery.onSnapshot((snapshot) => {
                        const stockMap = {};
                        snapshot.docs.forEach(doc => {
                            const data = doc.data();
                            stockMap[data.productId] = { ...data, docId: doc.id };
                        });
                        setBranchStock(stockMap);
                    }, (error) => console.error("Error fetching branch stock:", error));
                } else if (role === 'Admin') {
                    unsubBranchStock = db.collection(V8_COLLECTIONS.branchStock).onSnapshot((snapshot) => {
                        const stockMap = {};
                        snapshot.docs.forEach(doc => {
                            const data = doc.data();
                            if (!stockMap[data.branchId]) {
                                stockMap[data.branchId] = {};
                            }
                            stockMap[data.branchId][data.productId] = { ...data, docId: doc.id };
                        });
                        setBranchStock(stockMap); 
                    }, (error) => console.error("Error fetching all branch stock:", error));
                }

                // Main Warehouse Stock Subscription (Admin only)
                let unsubMWS = () => {};
                if (role === 'Admin') {
                    unsubMWS = db.collection(V8_COLLECTIONS.mainWarehouseStock).onSnapshot((snapshot) => {
                        const mwsMap = {};
                        snapshot.docs.forEach(doc => {
                            const data = doc.data();
                            mwsMap[doc.id] = data.currentStock;
                        });
                        setMainWarehouseStock(mwsMap);
                    }, (error) => console.error("Error fetching Main Warehouse stock:", error));
                }
                
                // Transfer History Subscription (Admin only)
                let unsubTransferHistory = () => {};
                if (role === 'Admin') {
                    const historyQuery = db.collection(V8_COLLECTIONS.transferHistory);
                    unsubTransferHistory = historyQuery.onSnapshot((snapshot) => {
                        const historyList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Sort newest first
                        historyList.sort((a, b) => {
                            const tsA = a.timestamp?.seconds || a.timestamp / 1000 || 0;
                            const tsB = b.timestamp?.seconds || b.timestamp / 1000 || 0;
                            return tsB - tsA;
                        }); 
                        setTransferHistory(historyList);
                    }, (error) => console.error("Error fetching transfer history:", error));
                }


                // Users Subscription (Admin only for lookup)
                let unsubUsers = () => {};
                if (role === 'Admin') {
                    unsubUsers = db.collection(V8_COLLECTIONS.users).onSnapshot((snapshot) => {
                        // We use the doc ID (which is the uid) as the id
                        const usersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setAllUsers(usersList);
                    }, (error) => console.error("Error fetching users:", error));
                }

                return () => {
                    unsubInventory();
                    unsubRequests();
                    unsubBranchStock();
                    if (unsubMWS) unsubMWS();
                    if (unsubUsers) unsubUsers();
                    if (unsubTransferHistory) unsubTransferHistory();
                };

            }, [db, currentUser, role, branchId]);


            // Helper: Find product info by ID
            const findProductById = useCallback((productId) => {
                return allInventory.find(item => item.id === productId);
            }, [allInventory]);

            // Helper: Find user info by ID (uid)
            const findUserById = useCallback((userId) => {
                // allUsers stores the doc id (uid) as 'id'
                return allUsers.find(user => user.id === userId);
            }, [allUsers]);

            // --- Loading/Error Screen ---
            if (isLoading) {
                return <div className="p-8 text-center text-xl font-semibold text-gray-700">Loading Application...</div>;
            }

            if (errorMessage) {
                return (
                    <div className="p-8 max-w-7xl mx-auto">
                        <div className="p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg shadow-md">
                            <h2 className="text-xl font-bold mb-2">Application Error</h2>
                            <p className="text-sm">{errorMessage}</p>
                            <p className="mt-4 text-sm font-semibold">
                                Action Required: You must grant read permission to all authenticated users for the 
                                <code className="bg-red-200 p-1 rounded mx-1">users</code> collection in your Firebase Security Rules.
                            </p>
                        </div>
                        {/* Render the rest of the Admin Dashboard if role was assumed */}
                        {role === 'Admin' && currentUser && (
                            <AdminDashboard 
                                db={db}
                                userId={currentUser.uid}
                                inventory={allInventory}
                                branchStock={branchStock}
                                mainWarehouseStock={mainWarehouseStock} 
                                requests={requests}
                                transferHistory={transferHistory} 
                                allUsers={allUsers}
                                findProductById={findProductById}
                                findUserById={findUserById} 
                            />
                        )}
                    </div>
                );
            }
            
            if (!role) {
                 return (
                    <div className="p-8 max-w-lg mx-auto bg-white shadow-xl rounded-xl mt-10">
                        <h1 className="text-2xl font-bold text-gray-800 mb-4">Access Denied / Role Setup</h1>
                        <p className="text-gray-600 mb-6">Your user profile ({currentUser?.uid || 'Unknown'}) is not assigned a role (Admin or Staff) or branch.</p>
                        <p className="text-sm text-red-500">
                            If this is the first run, please use the "User Management" tab (which appears for the first Admin) 
                            or manually add a document to the <code className="bg-red-200 p-1 rounded">.../public/data/users</code> collection 
                            with your UID (<code className="bg-red-200 p-1 rounded">{currentUser?.uid}</code>) as the document ID and a <code className="bg-red-200 p-1 rounded">role</code> of "Admin".
                        </p>
                    </div>
                );
            }

            // --- RENDER BASED ON ROLE ---
            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    <Header role={role} branchId={branchId} userId={currentUser?.uid} />
                    <div className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                        {role === 'Admin' ? (
                            <AdminDashboard 
                                db={db}
                                userId={currentUser.uid}
                                inventory={allInventory}
                                branchStock={branchStock}
                                mainWarehouseStock={mainWarehouseStock} 
                                requests={requests}
                                transferHistory={transferHistory} 
                                allUsers={allUsers}
                                findProductById={findProductById}
                                findUserById={findUserById} 
                            />
                        ) : (
                            <StaffInterface
                                db={db}
                                userId={currentUser.uid}
                                branchId={branchId}
                                inventory={allInventory}
                                branchStock={branchStock}
                                requests={requests}
                                findProductById={findProductById}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // --- HEADER COMPONENT ---
        const Header = ({ role, branchId, userId }) => (
            <header className="bg-white shadow-lg border-b border-indigo-200">
                <div className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <h1 className="text-3xl font-extrabold text-indigo-800 tracking-tight">
                        HairFix Inventory Manager
                    </h1>
                    <div className="text-right text-sm">
                        <p className="font-semibold text-gray-700">{role} Account</p>
                        {branchId && <p className="text-indigo-600">Branch ID: {branchId}</p>}
                        <p className="text-xs text-gray-500 truncate" title={userId}>User ID: {userId}</p>
                    </div>
                </div>
            </header>
        );


        // --- ADMIN DASHBOARD COMPONENTS ---

        // Tab Selector
        const AdminTabs = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard & Approvals' },
                { id: 'restock', name: 'Stock Movement & Restock' },
                { id: 'branch_view', name: 'Branch Stock View & History' }, 
                { id: 'products', name: 'Product Management' },
                { id: 'user_mgmt', name: 'User Management' }, // NEW TAB
            ];

            return (
                <div className="border-b border-gray-200 mb-6">
                    <nav className="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                        {tabs.map((tab) => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`
                                    ${tab.id === activeTab
                                        ? 'border-indigo-500 text-indigo-600'
                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }
                                    whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition duration-150
                                `}
                            >
                                {tab.name}
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        // Main Admin Dashboard
        const AdminDashboard = ({ db, userId, inventory, branchStock, mainWarehouseStock, requests, transferHistory, allUsers, findProductById, findUserById }) => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [systemMessage, setSystemMessage] = useState({ type: '', text: '' });

            // Filter Pending Requests
            const pendingRequests = useMemo(() => requests.filter(r => r.status === 'Pending'), [requests]);
            
            // Generate branch lists
            const branches = useMemo(() => {
                const branchIds = Array.from({ length: 16 }, (_, i) => `Branch_${String(i + 1).padStart(2, '0')}`);
                return [WHOLESALE_BRANCH_ID, ...branchIds];
            }, []);
            const staffBranches = useMemo(() => branches.filter(b => b !== WHOLESALE_BRANCH_ID), [branches]);


            // Find Low Stock Alerts (Admin view)
            const lowStockAlerts = useMemo(() => {
                const alerts = [];
                // branchStock is { branchId: { productId: data } }
                Object.entries(branchStock).forEach(([branchId, products]) => {
                    // Skip the wholesale pseudo-branch from alerts
                    if (branchId === WHOLESALE_BRANCH_ID) return;

                    Object.values(products).forEach(stockItem => {
                        const product = findProductById(stockItem.productId);
                        if (product && stockItem.currentStock <= product.lowStockThreshold) {
                            alerts.push({
                                branchId,
                                productName: getProductNameDisplay(product),
                                currentStock: stockItem.currentStock,
                                threshold: product.lowStockThreshold,
                            });
                        }
                    });
                });
                return alerts;
            }, [branchStock, findProductById]);

            // Handle Approval/Rejection of Request
            const handleApproval = async (request, newStatus) => {
                setSystemMessage({ type: '', text: 'Processing request...' });
                
                // V8 Transaction syntax
                try {
                    await db.runTransaction(async (transaction) => {
                        
                        const requestRef = db.collection(V8_COLLECTIONS.requests).doc(request.id);
                        const docId = `${request.branchId}_${request.productId}`;
                        const branchStockRef = db.collection(V8_COLLECTIONS.branchStock).doc(docId);

                        // READS
                        const stockSnap = await transaction.get(branchStockRef);

                        // Check stock existence/values before writing
                        if (newStatus === 'Approved') {
                            if (!stockSnap.exists) {
                                throw new Error("Branch stock item not found for update.");
                            }
                            const currentStock = stockSnap.data().currentStock || 0;
                            const newStock = currentStock - request.quantityRequested;

                            if (newStock < 0) {
                                throw new Error(`Insufficient stock at branch ${request.branchId}. Current: ${currentStock}, Requested: ${request.quantityRequested}`);
                            }

                            // WRITES: Update Branch Stock
                            transaction.update(branchStockRef, {
                                currentStock: newStock,
                            });
                        }
                        
                        // WRITES: Update Request Status
                        transaction.update(requestRef, {
                            status: newStatus,
                            approvalTimestamp: Date.now(),
                            approvedByUserId: userId,
                        });

                    });

                    setSystemMessage({ type: 'success', text: `Request ${request.id} has been ${newStatus}.` });
                } catch (error) {
                    console.error(`Transaction failed for ${newStatus}:`, error);
                    setSystemMessage({ type: 'error', text: `Failed to ${newStatus} request: ${error.message}` });
                }
            };

            const tabContent = {
                'dashboard': (
                    <>
                        {/* Display system message here as it's shared across tabs */}
                        {systemMessage.text && (
                            <div className={`p-3 mb-4 rounded-lg text-sm ${systemMessage.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                {systemMessage.text}
                            </div>
                        )}
                        <MainWarehouseStatus mainWarehouseStock={mainWarehouseStock} inventory={inventory} findProductById={findProductById} />
                        <LowStockAlerts alerts={lowStockAlerts} />
                        <PendingApprovals 
                            pendingRequests={pendingRequests} 
                            findProductById={findProductById} 
                            findUserById={findUserById}
                            handleApproval={handleApproval}
                        />
                    </>
                ),
                'restock': (
                    <RestockInventory 
                        db={db} 
                        userId={userId} 
                        inventory={inventory} 
                        branchStock={branchStock} 
                        mainWarehouseStock={mainWarehouseStock}
                        branches={branches} // Pass branches list
                        setSystemMessage={setSystemMessage}
                    />
                ),
                'branch_view': ( 
                    <>
                        <BranchStockViewer 
                            inventory={inventory} 
                            branchStock={branchStock} 
                            branches={branches} // Pass branches list
                            findProductById={findProductById} 
                        />
                        <TransferHistoryViewer 
                            transferHistory={transferHistory}
                            findProductById={findProductById}
                            findUserById={findUserById}
                        />
                    </>
                ),
                'products': (
                    <ProductManagement 
                        db={db} 
                        inventory={inventory} 
                        branchStock={branchStock} 
                        requests={requests} 
                        setSystemMessage={setSystemMessage}
                    />
                ),
                'user_mgmt': ( // NEW CONTENT
                    <UserManagement
                        db={db}
                        allUsers={allUsers}
                        staffBranches={staffBranches}
                        setSystemMessage={setSystemMessage}
                    />
                ),
            };

            return (
                <div>
                    <AdminTabs activeTab={activeTab} setActiveTab={setActiveTab} />
                    {/* Render content and system message if not on dashboard tab */}
                    {activeTab !== 'dashboard' && systemMessage.text && (
                        <div className={`p-3 mb-4 rounded-lg text-sm ${systemMessage.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                            {systemMessage.text}
                        </div>
                    )}
                    {tabContent[activeTab]}
                </div>
            );
        };

        // Admin Sub-Component: Main Warehouse Stock Status
        const MainWarehouseStatus = ({ mainWarehouseStock, inventory, findProductById }) => {
            
            const statusData = useMemo(() => {
                const data = Object.entries(mainWarehouseStock).map(([productId, stock]) => {
                    const product = findProductById(productId);
                    if (!product) return null;
                    return {
                        name: getProductNameDisplay(product),
                        stock: stock,
                        unit: product.unitOfMeasure,
                        id: productId,
                    };
                }).filter(Boolean);

                return data.sort((a, b) => b.stock - a.stock);
            }, [mainWarehouseStock, findProductById]);

            return (
                <div className="mb-8 p-6 bg-blue-100 border-l-4 border-blue-500 rounded-lg shadow-md">
                    <h2 className="text-xl font-semibold text-blue-800 mb-4 flex items-center">
                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 7 9h-4l.15 1.5M6.343 7.343a8 8 0 0111.314 11.314M12 20a8 8 0 008-8h-4a4 4 0 01-4 4v4z"></path></svg>
                        Main Warehouse Stock (MWS)
                    </h2>
                    {statusData.length === 0 ? (
                        <p className="text-blue-700">The Main Warehouse currently holds no stock records. Use the "Stock Movement" tab to add stock.</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-blue-300">
                                <thead className="bg-blue-200">
                                    <tr>
                                        <th className="py-2 px-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Product</th>
                                        <th className="py-2 px-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">MWS Stock</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-blue-200 bg-white">
                                    {statusData.map((item) => (
                                        <tr key={item.id} className="hover:bg-blue-50">
                                            <td className="py-2 px-3 whitespace-nowrap text-sm font-medium text-blue-900">{item.name}</td>
                                            <td className="py-2 px-3 whitespace-nowrap text-sm font-bold text-indigo-700">{item.stock} {item.unit}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };


        // Admin Sub-Component: Low Stock Alerts
        const LowStockAlerts = ({ alerts }) => (
            <div className="mb-8 p-6 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold text-yellow-800 mb-4 flex items-center">
                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Low Stock Alerts ({alerts.length})
                </h2>
                {alerts.length === 0 ? (
                    <p className="text-yellow-700">All branches are currently above minimum stock thresholds.</p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-yellow-300">
                            <thead className="bg-yellow-200">
                                <tr>
                                    <th className="py-2 px-3 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">Branch ID</th>
                                    <th className="py-2 px-3 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">Product</th>
                                    <th className="py-2 px-3 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">Stock</th>
                                    <th className="py-2 px-3 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">Threshold</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-yellow-200 bg-white">
                                {alerts.map((alert, index) => (
                                    <tr key={index} className="hover:bg-yellow-50">
                                        <td className="py-2 px-3 whitespace-nowrap text-sm font-medium text-yellow-900">{alert.branchId}</td>
                                        <td className="py-2 px-3 whitespace-nowrap text-sm text-yellow-700">{alert.productName}</td>
                                        <td className="py-2 px-3 whitespace-nowrap text-sm text-red-600 font-bold">{alert.currentStock}</td>
                                        <td className="py-2 px-3 whitespace-nowrap text-sm text-yellow-700">{alert.threshold}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        );
        
        // Admin Sub-Component: Pending Approvals
        const PendingApprovals = ({ pendingRequests, findProductById, findUserById, handleApproval }) => (
            <div className="bg-white p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Pending Consumption Requests ({pendingRequests.length})</h2>
                
                {pendingRequests.length === 0 ? (
                    <p className="text-gray-500 italic">No pending requests require approval.</p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch/User</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purpose</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {pendingRequests.map(request => {
                                    const product = findProductById(request.productId);
                                    const user = findUserById(request.requestedByUserId);
                                    return (
                                        <tr key={request.id}>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                {request.branchId}
                                                <div className="text-xs text-gray-500 truncate" title={user ? user.id : 'Unknown User'}>
                                                    {user ? user.id : 'Unknown User'}
                                                </div>
                                            </td>
                                            <td className="py-3 px-4 whitespace-normal text-sm text-gray-600">
                                                {product ? getProductNameDisplay(product) : 'Product Not Found'}
                                            </td>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm font-bold text-indigo-600">{request.quantityRequested}</td>
                                            <td className="py-3 px-4 whitespace-normal text-sm text-gray-500 max-w-xs">{request.purpose}</td>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <Button onClick={() => handleApproval(request, 'Approved')} className="bg-green-600 hover:bg-green-700">Approve</Button>
                                                <Button onClick={() => handleApproval(request, 'Rejected')} className="bg-red-600 hover:bg-red-700">Reject</Button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        );

        // Admin Sub-Component: Stock Movement & Restock
        const RestockInventory = memo(({ db, userId, inventory, branchStock, mainWarehouseStock, branches, setSystemMessage }) => {
            const [actionType, setActionType] = useState('ADD_TO_MWS'); // ADD_TO_MWS or TRANSFER
            const [selectedDestination, setSelectedDestination] = useState(''); // Branch ID or WHOLESALE_CLIENTS
            const [selectedProduct, setSelectedProduct] = useState(''); // Stores productId
            const [quantity, setQuantity] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            // Get the current stock for display based on action type
            const sourceStock = useMemo(() => {
                if (!selectedProduct) return 0;

                if (actionType === 'ADD_TO_MWS') {
                    return 0; // Source is external supplier
                } else if (actionType === 'TRANSFER') {
                    return mainWarehouseStock[selectedProduct] || 0; // Source is MWS (MWS map uses productId as key)
                }
                return 0;
            }, [actionType, selectedProduct, mainWarehouseStock]);

            const destinationStock = useMemo(() => {
                if (!selectedDestination || !selectedProduct) return 0;
                
                // branchStock structure: { branchId: { productId: data } }
                return branchStock[selectedDestination]?.[selectedProduct]?.currentStock || 0;
            }, [selectedDestination, selectedProduct, branchStock]);
            
            // Reset secondary fields when action changes
            useEffect(() => {
                setSelectedDestination('');
                setSelectedProduct('');
                setQuantity('');
            }, [actionType]);
            
            // --- STABILIZED STATE HANDLERS ---
            const handleQuantityChange = useCallback((e) => setQuantity(e.target.value), []);
            const handleProductChange = useCallback((e) => setSelectedProduct(e.target.value), []);
            const handleDestinationChange = useCallback((e) => setSelectedDestination(e.target.value), []);

            const handleRestock = useCallback(async (e) => {
                e.preventDefault();
                const quantityNum = Number(quantity);
                if (!selectedProduct || quantityNum <= 0 || (actionType === 'TRANSFER' && !selectedDestination)) {
                    setSystemMessage({ type: 'error', text: 'Please fill out all fields correctly.' });
                    return;
                }

                if (actionType === 'TRANSFER' && quantityNum > sourceStock) {
                    setSystemMessage({ type: 'error', text: `Transfer quantity (${quantityNum}) exceeds Main Warehouse stock (${sourceStock}).` });
                    return;
                }

                setIsSubmitting(true);
                setSystemMessage({ type: '', text: 'Processing stock movement...' });
                
                // V8 Transaction syntax
                try {
                    await db.runTransaction(async (transaction) => {
                        const mwsRef = db.collection(V8_COLLECTIONS.mainWarehouseStock).doc(selectedProduct);
                        
                        if (actionType === 'ADD_TO_MWS') {
                            // --- Scenario 1: Add stock from supplier directly to MWS ---
                            
                            // READS
                            const mwsSnap = await transaction.get(mwsRef);
                            const currentMWS = mwsSnap.exists ? mwsSnap.data().currentStock : 0;
                            
                            // WRITES
                            // Use set with merge: true to handle both create and update
                            transaction.set(mwsRef, {
                                currentStock: currentMWS + quantityNum,
                            }, { merge: true });
                            
                        } else if (actionType === 'TRANSFER') {
                            // --- Scenario 2: Transfer stock from MWS to Branch (or Wholesale Client) ---

                            // 2a. READS: Get MWS and Destination Stock snaps first
                            const mwsSnap = await transaction.get(mwsRef);
                            const destDocId = `${selectedDestination}_${selectedProduct}`;
                            const destStockRef = db.collection(V8_COLLECTIONS.branchStock).doc(destDocId);
                            const destStockSnap = await transaction.get(destStockRef);

                            // VALIDATION (Check MWS stock)
                            const currentMWS = mwsSnap.exists ? mwsSnap.data().currentStock : 0;
                            if (currentMWS < quantityNum) {
                                throw new Error("Insufficient stock in Main Warehouse for transfer.");
                            }
                            
                            // 2b. WRITES: Deduct from MWS
                            transaction.update(mwsRef, {
                                currentStock: currentMWS - quantityNum,
                            });
                            
                            // 2c. WRITES: Add to BranchStock (or WHOLESALE_CLIENTS ledger)
                            const currentDestStock = destStockSnap.exists ? destStockSnap.data().currentStock : 0;
                            
                            // Use set with merge: true to handle both create and update
                            transaction.set(destStockRef, {
                                branchId: selectedDestination,
                                productId: selectedProduct,
                                currentStock: currentDestStock + quantityNum,
                                lastRestockTimestamp: Date.now(),
                                lastRestockedByUserId: userId,
                            }, { merge: true });

                            // 2d. WRITES: Record in TransferHistory 
                            const transferHistoryRef = db.collection(V8_COLLECTIONS.transferHistory).doc(); // Auto-generate ID
                            transaction.set(transferHistoryRef, {
                                productId: selectedProduct,
                                quantity: quantityNum,
                                fromLocation: MAIN_WAREHOUSE_ID,
                                toLocation: selectedDestination,
                                timestamp: Date.now(),
                                executedByUserId: userId,
                            });
                        }
                    });

                    setSystemMessage({ type: 'success', text: `Stock movement processed successfully.` });
                    setSelectedDestination('');
                    setSelectedProduct('');
                    setQuantity('');
                    setActionType('ADD_TO_MWS'); // Reset to default
                } catch (error) {
                    console.error("Stock movement transaction failed:", error);
                    setSystemMessage({ type: 'error', text: `Failed to process movement: ${error.message}` });
                } finally {
                    setIsSubmitting(false);
                }
            }, [db, userId, quantity, selectedProduct, actionType, selectedDestination, sourceStock, setSystemMessage]); // Dependencies are crucial for useCallback

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Stock Movement & Restock</h2>
                    
                    <div className="flex space-x-4 mb-6">
                        <Button 
                            onClick={() => setActionType('ADD_TO_MWS')} 
                            className={actionType === 'ADD_TO_MWS' ? 'bg-green-600' : 'bg-gray-400 hover:bg-gray-500'}
                        >
                            Add Stock to Main Warehouse (From Supplier)
                        </Button>
                        <Button 
                            onClick={() => setActionType('TRANSFER')} 
                            className={actionType === 'TRANSFER' ? 'bg-indigo-600' : 'bg-gray-400 hover:bg-gray-500'}
                        >
                            Transfer Stock (MWS to Branch/Wholesale)
                        </Button>
                    </div>
                    
                    <form onSubmit={handleRestock} className="space-y-4 p-4 border rounded-lg bg-gray-50">

                        {actionType === 'TRANSFER' && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Transfer Destination</label>
                                <select
                                    value={selectedDestination}
                                    onChange={handleDestinationChange}
                                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                    required
                                >
                                    <option value="" disabled>Select Branch or Wholesale Client</option>
                                    {branches.map(branch => (
                                        <option key={branch} value={branch}>
                                            {branch === WHOLESALE_BRANCH_ID ? `External: ${branch}` : branch}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        )}
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Select Product</label>
                            <select
                                value={selectedProduct}
                                onChange={handleProductChange}
                                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                required
                            >
                                <option value="" disabled>Select a product</option>
                                {inventory.map(product => (
                                    <option key={product.id} value={product.id}>
                                        {getProductNameDisplay(product)}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Quantity to {actionType === 'ADD_TO_MWS' ? 'Add' : 'Transfer'}</label>
                            <input
                                type="number"
                                min="1"
                                value={quantity}
                                onChange={handleQuantityChange}
                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="Enter quantity"
                                required
                            />
                        </div>
                        
                        {selectedProduct && (
                            <div className="text-sm text-gray-600 font-medium pt-2 border-t mt-4">
                                {actionType === 'TRANSFER' && (
                                    <p className="mb-1">
                                        **Source Stock (MWS):** <span className={`font-bold ml-2 ${sourceStock < quantity ? 'text-red-600' : 'text-indigo-600'}`}>
                                            {sourceStock}
                                        </span>
                                    </p>
                                )}
                                {actionType === 'TRANSFER' && selectedDestination && (
                                    <p>
                                        **Destination Stock ({selectedDestination === WHOLESALE_BRANCH_ID ? 'Wholesale Ledger' : selectedDestination}):** <span className="font-bold ml-2 text-indigo-600">
                                            {destinationStock}
                                        </span>
                                    </p>
                                )}
                            </div>
                        )}

                        <Button type="submit" disabled={isSubmitting || (actionType === 'TRANSFER' && quantityNum > sourceStock && quantityNum > 0)}>
                            {isSubmitting ? 'Processing...' : actionType === 'ADD_TO_MWS' ? 'Add to MWS' : 'Execute Transfer'}
                        </Button>
                    </form>
                </div>
            );
        });


        // Admin Sub-Component: Product Management Modal (Moved outside to ensure stability)
        const ProductManagementModal = ({ 
            editingProduct, form, handleFormChange, handleSave, setIsModalOpen 
        }) => {
            const handleFormChangeInner = handleFormChange; 
            
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50">
                    <div className="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
                        <h3 className="text-lg font-bold text-gray-900 mb-4">{editingProduct ? 'Edit Product' : 'Add New Product'}</h3>
                        <form onSubmit={handleSave} className="space-y-3">
                            {['productName', 'company'].map(field => (
                                <div key={field}>
                                    <label className="block text-sm font-medium text-gray-700 capitalize">{field.replace(/([A-Z])/g, ' $1')}</label>
                                    <input
                                        type="text"
                                        name={field}
                                        value={form[field]}
                                        onChange={handleFormChangeInner}
                                        required
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                    />
                                </div>
                            ))}
                            {/* Updated Size input with helper text for consumables */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Size / Category</label>
                                <input
                                    type="text"
                                    name="size"
                                    value={form.size}
                                    onChange={handleFormChangeInner}
                                    required
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="e.g., 7/5 or 'Consumable' for tapes/glues"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                    Use specific dimensions (e.g., 7/5) for patches, and a general term (e.g., **Consumable**) for items like glue or tape.
                                </p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700">Unit of Measure</label>
                                <input
                                    type="text"
                                    name="unitOfMeasure"
                                    value={form.unitOfMeasure}
                                    onChange={handleFormChangeInner}
                                    required
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="e.g., pc, bottle, roll"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                                <input
                                    type="number"
                                    min="1"
                                    name="lowStockThreshold"
                                    value={form.lowStockThreshold}
                                    onChange={handleFormChangeInner}
                                    required
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                />
                            </div>
                            <div className="flex justify-end space-x-2 pt-4">
                                <Button onClick={() => setIsModalOpen(false)} className="bg-gray-500 hover:bg-gray-600" type="button">Cancel</Button>
                                <Button type="submit" className="bg-indigo-600 hover:bg-indigo-700">Save Product</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };


        // Admin Sub-Component: Product Management
        const ProductManagement = memo(({ db, inventory, branchStock, requests, setSystemMessage }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            
            const initialFormState = {
                productName: '', company: '', size: '', unitOfMeasure: '', lowStockThreshold: 1,
            };
            const [form, setForm] = useState(initialFormState);

            const openModal = (product = null) => {
                setEditingProduct(product);
                setForm(product ? { ...product } : initialFormState); // Use spread to avoid mutation
                setIsModalOpen(true);
            };

            // Stabilized function for handling input changes
            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                setForm(prevForm => ({ ...prevForm, [name]: value }));
            }, []);

            // Stabilized function for saving the form
            const handleSave = useCallback(async (e) => {
                e.preventDefault();
                setSystemMessage({ type: '', text: 'Saving product...' });

                try {
                    const dataToSave = {
                        ...form,
                        lowStockThreshold: Number(form.lowStockThreshold) || 1
                    };
                    
                    if (editingProduct) {
                        // V8 Update/Edit
                        const docRef = db.collection(V8_COLLECTIONS.inventory).doc(editingProduct.id);
                        await docRef.update(dataToSave);
                        setSystemMessage({ type: 'success', text: `Product ${editingProduct.id} updated successfully.` });
                    } else {
                        // V8 Create/Add
                        await db.collection(V8_COLLECTIONS.inventory).add(dataToSave);
                        setSystemMessage({ type: 'success', text: `New product added successfully.` });
                    }
                    setIsModalOpen(false);
                } catch (error) {
                    console.error("Failed to save product:", error);
                    setSystemMessage({ type: 'error', text: `Failed to save product: ${error.message}` });
                }
            }, [db, editingProduct, form, setSystemMessage]);

            // Stabilized function for deleting a product
            const handleDelete = useCallback(async (productId) => {
                // NOTE: Replaced window.confirm with a simpler check for this environment
                if (prompt("Type 'DELETE' to confirm deletion. This action cannot be undone.") !== "DELETE") {
                    setSystemMessage({ type: 'error', text: 'Deletion cancelled.' });
                    return;
                }

                // Check for dependencies (BranchStock, Pending Requests)
                const isUsedInStock = Object.values(branchStock).some(branch => branch[productId]);
                const isUsedInPendingRequest = requests.some(r => r.productId === productId && r.status === 'Pending');

                if (isUsedInStock || isUsedInPendingRequest) {
                    setSystemMessage({ 
                        type: 'error', 
                        text: 'Cannot delete product: It is currently tracked in a branch or has a pending consumption request.' 
                    });
                    return;
                }

                setSystemMessage({ type: '', text: 'Deleting product...' });
                try {
                    // V8 Delete
                    await db.collection(V8_COLLECTIONS.inventory).doc(productId).delete();
                    setSystemMessage({ type: 'success', text: 'Product deleted successfully.' });
                } catch (error) {
                    console.error("Failed to delete product:", error);
                    setSystemMessage({ type: 'error', text: `Failed to delete product: ${error.message}` });
                }
            }, [db, branchStock, requests, setSystemMessage]);

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
                        Master Product List
                        <Button onClick={() => openModal()} className="bg-green-600 hover:bg-green-700">Add New Product</Button>
                    </h2>
                    {isModalOpen && (
                        <ProductManagementModal 
                            editingProduct={editingProduct}
                            form={form}
                            handleFormChange={handleFormChange} // Pass the stabilized handler
                            handleSave={handleSave}
                            setIsModalOpen={setIsModalOpen}
                        />
                    )}
                    
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product ID</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size/Category</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Threshold</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {inventory.map(product => (
                                    <tr key={product.id}>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900 truncate max-w-xs">{product.id}</td>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-600">{product.company}</td>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-600">{product.productName}</td>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm text-indigo-600 font-medium">{product.size}</td>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-600">{product.unitOfMeasure}</td>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm text-red-500 font-bold">{product.lowStockThreshold}</td>
                                        <td className="py-3 px-4 whitespace-nowrap text-sm font-medium space-x-2">
                                            <Button onClick={() => openModal(product)} className="bg-blue-600 hover:bg-blue-700">Edit</Button>
                                            <Button onClick={() => handleDelete(product.id)} className="bg-red-600 hover:bg-red-700">Delete</Button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        });


        // Admin Sub-Component: Branch Stock Viewer
        const BranchStockViewer = ({ inventory, branchStock, branches, findProductById }) => {
            const [selectedBranch, setSelectedBranch] = useState('');
            
            // Filter stock data for the selected branch
            const filteredStock = useMemo(() => {
                if (!selectedBranch || !branchStock[selectedBranch]) return [];

                return Object.values(branchStock[selectedBranch])
                    .map(stockItem => {
                        const product = findProductById(stockItem.productId);
                        if (!product) return null;
                        const isLow = stockItem.currentStock <= product.lowStockThreshold;

                        return {
                            ...product,
                            currentStock: stockItem.currentStock,
                            isLow: isLow,
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => b.isLow - a.isLow || a.productName.localeCompare(b.productName));
            }, [selectedBranch, branchStock, findProductById]);


            return (
                <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Branch Stock Inventory</h2>
                    
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700">Select Branch to View</label>
                        <select
                            value={selectedBranch}
                            onChange={(e) => setSelectedBranch(e.target.value)}
                            className="mt-1 block w-full lg:w-1/3 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                        >
                            <option value="" disabled>Select a branch or Wholesale Ledger</option>
                            {branches.map(branch => (
                                <option key={branch} value={branch}>
                                    {branch === WHOLESALE_BRANCH_ID ? `External: ${branch}` : branch}
                                </option>
                            ))}
                        </select>
                    </div>

                    {selectedBranch && filteredStock.length === 0 && (
                        <p className="p-4 bg-gray-100 rounded-md text-gray-600">No stock records found for {selectedBranch}.</p>
                    )}

                    {filteredStock.length > 0 && (
                        <div className="overflow-x-auto">
                            <h3 className="text-lg font-semibold text-gray-700 mb-2">Inventory for: {selectedBranch}</h3>
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size/Category</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Threshold</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredStock.map(item => (
                                        <tr key={item.id} className={item.isLow ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50'}>
                                            <td className="py-3 px-4 whitespace-normal text-sm font-medium text-gray-900">{getProductNameDisplay(item)}</td>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm text-indigo-600">{item.size}</td>
                                            <td className={`py-3 px-4 whitespace-nowrap text-sm font-bold ${item.isLow ? 'text-red-700' : 'text-green-700'}`}>
                                                {item.currentStock} {item.unitOfMeasure}
                                            </td>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-500">{item.lowStockThreshold}</td>
                                            <td className={`py-3 px-4 whitespace-nowrap text-xs font-semibold`}>
                                                <span className={`px-2 inline-flex leading-5 rounded-full ${item.isLow ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                    {item.isLow ? 'LOW' : 'OK'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Admin Sub-Component: Transfer History Viewer
        const TransferHistoryViewer = ({ transferHistory, findProductById, findUserById }) => {
            return (
                <div className="bg-white p-6 rounded-xl shadow-lg mt-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Main Warehouse Transfer History</h2>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To Location</th>
                                    <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Executed By</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {transferHistory.map(transfer => {
                                    const product = findProductById(transfer.productId);
                                    const user = findUserById(transfer.executedByUserId);
                                    
                                    return (
                                        <tr key={transfer.id} className="hover:bg-gray-50">
                                            <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-500">
                                                {new Date(transfer.timestamp).toLocaleString()}
                                            </td>
                                            <td className="py-3 px-4 whitespace-normal text-sm font-medium text-gray-900">
                                                {product ? getProductNameDisplay(product) : 'Unknown Product'}
                                            </td>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm font-bold text-indigo-600">
                                                {transfer.quantity} {product ? product.unitOfMeasure : ''}
                                            </td>
                                            <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-600">
                                                {transfer.toLocation === WHOLESALE_BRANCH_ID ? 'WHOLESALE CLIENTS' : transfer.toLocation}
                                            </td>
                                            <td className="py-3 px-4 whitespace-nowrap text-xs text-gray-500" title={user ? user.id : 'Unknown User'}>
                                                {user ? user.id : 'Unknown User'}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        {transferHistory.length === 0 && (
                            <p className="p-4 text-center text-gray-500 italic">No transfers have been recorded yet.</p>
                        )}
                    </div>
                </div>
            );
        };

        // NEW: Admin Sub-Component: User Management
        const UserManagement = memo(({ db, allUsers, staffBranches, setSystemMessage }) => {
            const [newUserId, setNewUserId] = useState('');
            const [newUserRole, setNewUserRole] = useState('Staff');
            const [newUserBranch, setNewUserBranch] = useState(staffBranches[0] || '');
            const [isSubmittingNew, setIsSubmittingNew] = useState(false);

            // State for inline editing
            const [editingState, setEditingState] = useState({}); // { [userId]: { role, branchId } }

            const handleAddNewUser = async (e) => {
                e.preventDefault();
                if (!newUserId) {
                    setSystemMessage({ type: 'error', text: 'New User ID cannot be empty.' });
                    return;
                }

                setIsSubmittingNew(true);
                setSystemMessage({ type: '', text: 'Adding new user...' });

                try {
                    const branchId = newUserRole === 'Admin' ? null : newUserBranch;
                    await db.collection(V8_COLLECTIONS.users).doc(newUserId).set({
                        role: newUserRole,
                        branchId: branchId,
                        userId: newUserId // Store userId in the doc for easy lookup if needed
                    });
                    setSystemMessage({ type: 'success', text: `User ${newUserId} added successfully.` });
                    setNewUserId('');
                    setNewUserRole('Staff');
                    setNewUserBranch(staffBranches[0] || '');
                } catch (error) {
                    console.error("Failed to add user:", error);
                    setSystemMessage({ type: 'error', text: `Failed to add user: ${error.message}` });
                } finally {
                    setIsSubmittingNew(false);
                }
            };
            
            // Handle changes in the edit-in-place fields
            const handleEditChange = (userId, field, value) => {
                setEditingState(prev => ({
                    ...prev,
                    [userId]: {
                        ...prev[userId], // Start with existing edits
                        ...(allUsers.find(u => u.id === userId)), // Fallback to original data
                        [field]: value,
                        // If role changes to Admin, nullify branchId
                        ...(field === 'role' && value === 'Admin' && { branchId: null })
                    }
                }));
            };

            const handleUpdateUser = async (userId) => {
                const userState = editingState[userId] || allUsers.find(u => u.id === userId);
                if (!userState) return;
                
                setSystemMessage({ type: '', text: `Updating user ${userId}...` });
                
                try {
                    await db.collection(V8_COLLECTIONS.users).doc(userId).update({
                        role: userState.role,
                        branchId: userState.role === 'Admin' ? null : userState.branchId
                    });
                    setSystemMessage({ type: 'success', text: `User ${userId} updated successfully.` });
                    // Clear editing state for this user
                    setEditingState(prev => {
                        const next = {...prev};
                        delete next[userId];
                        return next;
                    });
                } catch (error) {
                    console.error("Failed to update user:", error);
                    setSystemMessage({ type: 'error', text: `Failed to update user: ${error.message}` });
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg space-y-8">
                    {/* --- Add New User Form --- */}
                    <div className="border-b pb-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Add New User</h2>
                        <form onSubmit={handleAddNewUser} className="space-y-4 p-4 border rounded-lg bg-gray-50">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">User ID (Auth UID)</label>
                                <input
                                    type="text"
                                    value={newUserId}
                                    onChange={(e) => setNewUserId(e.target.value)}
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="Enter the User's Firebase Auth UID"
                                    required
                                />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Role</label>
                                    <select
                                        value={newUserRole}
                                        onChange={(e) => setNewUserRole(e.target.value)}
                                        className="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                    >
                                        <option value="Staff">Staff</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Branch</label>
                                    <select
                                        value={newUserBranch}
                                        onChange={(e) => setNewUserBranch(e.target.value)}
                                        className="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                        disabled={newUserRole === 'Admin'}
                                    >
                                        {staffBranches.map(branch => (
                                            <option key={branch} value={branch}>{branch}</option>
                                        ))}
                                    </select>
                                    {newUserRole === 'Admin' && <p className="text-xs text-gray-500 mt-1">Admins are not assigned a branch.</p>}
                                </div>
                            </div>
                            <Button type="submit" disabled={isSubmittingNew} className="bg-green-600 hover:bg-green-700">
                                {isSubmittingNew ? 'Adding...' : 'Add User'}
                            </Button>
                        </form>
                    </div>

                    {/* --- Existing Users List --- */}
                    <div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Existing Users</h2>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID (UID)</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch ID</th>
                                        <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {allUsers.map(user => {
                                        const state = editingState[user.id] || user;
                                        return (
                                            <tr key={user.id}>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900 truncate max-w-xs" title={user.id}>{user.id}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm">
                                                    <select
                                                        value={state.role}
                                                        onChange={(e) => handleEditChange(user.id, 'role', e.target.value)}
                                                        className="block w-full p-2 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                                    >
                                                        <option value="Staff">Staff</option>
                                                        <option value="Admin">Admin</option>
                                                    </select>
                                                </td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm">
                                                    <select
                                                        value={state.branchId || ''}
                                                        onChange={(e) => handleEditChange(user.id, 'branchId', e.target.value)}
                                                        className="block w-full p-2 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                                        disabled={state.role === 'Admin'}
                                                    >
                                                        <option value="" disabled>Select Branch</option>
                                                        {staffBranches.map(branch => (
                                                            <option key={branch} value={branch}>{branch}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm">
                                                    <Button onClick={() => handleUpdateUser(user.id)} className="bg-blue-600 hover:bg-blue-700">Update</Button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        });


        // --- STAFF INTERFACE COMPONENTS ---

        const StaffInterface = ({ db, userId, branchId, inventory, branchStock, requests, findProductById }) => {
            
            // Group requests for staff history
            const staffRequests = useMemo(() => {
                return requests.filter(r => r.branchId === branchId);
            }, [requests, branchId]);

            // Filter staff inventory to only show items they actually stock
            const staffInventory = useMemo(() => {
                // branchStock for staff is structured as { productId: data }
                const stockedProductIds = Object.keys(branchStock);
                
                return inventory.filter(item => stockedProductIds.includes(item.id));
            }, [inventory, branchStock]);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-1">
                        <ConsumptionRequestForm 
                            db={db} 
                            userId={userId} 
                            branchId={branchId}
                            staffInventory={staffInventory}
                            branchStock={branchStock}
                        />
                    </div>
                    <div className="lg:col-span-2">
                        <StaffRequestHistory 
                            staffRequests={staffRequests} 
                            findProductById={findProductById}
                        />
                    </div>
                    
                    <div className="lg:col-span-3">
                        <BranchInventoryStatus 
                            staffInventory={staffInventory}
                            branchStock={branchStock}
                        />
                    </div>
                </div>
            );
        };

        // Staff Sub-Component: Consumption Request Form (Includes 2-step filtering)
        const ConsumptionRequestForm = memo(({ db, userId, branchId, staffInventory, branchStock }) => {
            const [selectedSize, setSelectedSize] = useState('');
            const [selectedProduct, setSelectedProduct] = useState(''); // Stores productId
            const [quantity, setQuantity] = useState('');
            const [purpose, setPurpose] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });

            // 1. Get Unique Sizes (including 'Consumable' or any other category)
            const uniqueSizes = useMemo(() => {
                const sizes = staffInventory.map(item => item.size);
                return [...new Set(sizes)].sort();
            }, [staffInventory]);

            // 2. Filter Products based on selected Size/Category
            const filteredProducts = useMemo(() => {
                if (!selectedSize) return [];
                return staffInventory
                    .filter(item => item.size === selectedSize)
                    .sort((a, b) => getProductNameDisplay(a).localeCompare(getProductNameDisplay(b)));
            }, [staffInventory, selectedSize]);

            // Reset product selection if size changes
            useEffect(() => {
                setSelectedProduct('');
            }, [selectedSize]);

            // Get current stock for the selected product
            const currentStock = useMemo(() => {
                if (!selectedProduct) return 0;
                return branchStock[selectedProduct]?.currentStock || 0;
            }, [branchStock, selectedProduct]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const quantityNum = Number(quantity);
                if (!selectedProduct || quantityNum <= 0 || !purpose) {
                    setMessage({ type: 'error', text: 'Please select a product, enter a valid quantity, and state the purpose.' });
                    return;
                }

                if (quantityNum > currentStock) {
                    setMessage({ type: 'error', text: `Requested quantity (${quantityNum}) exceeds current stock (${currentStock}). Cannot submit request.` });
                    return;
                }

                setIsSubmitting(true);
                setMessage({ type: '', text: 'Submitting request for Admin approval...' });
                
                try {
                    // V8 Add Document
                    await db.collection(V8_COLLECTIONS.requests).add({
                        branchId,
                        productId: selectedProduct,
                        quantityRequested: quantityNum,
                        purpose: purpose,
                        status: "Pending",
                        requestTimestamp: Date.now(),
                        requestedByUserId: userId,
                    });

                    setMessage({ type: 'success', text: 'Consumption request submitted successfully! Awaiting Admin approval.' });
                    setSelectedSize('');
                    setSelectedProduct('');
                    setQuantity('');
                    setPurpose('');
                } catch (error) {
                    console.error("Failed to submit request:", error);
                    setMessage({ type: 'error', text: `Failed to submit request: ${error.message}` });
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg h-full">
                    <h2 className="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Submit Consumption Request</h2>
                    
                    {message.text && (
                        <div className={`p-3 mb-4 rounded-lg text-sm ${message.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                            {message.text}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-4">
                        {/* Step 1: Select Size/Category */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700">1. Select Size / Category</label>
                            <select
                                value={selectedSize}
                                onChange={(e) => setSelectedSize(e.target.value)}
                                className="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm"
                                required
                            >
                                <option value="" disabled>Select size (e.g., 7/5) or 'Consumable'</option>
                                {uniqueSizes.map(size => <option key={size} value={size}>{size}</option>)}
                            </select>
                        </div>

                        {/* Step 2: Select Product (filtered by size/category) */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700">2. Select Product/Company</label>
                            <select
                                value={selectedProduct}
                                onChange={(e) => setSelectedProduct(e.target.value)}
                                className="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm"
                                disabled={!selectedSize}
                                required
                            >
                                <option value="" disabled>Select model/company</option>
                                {filteredProducts.map(product => (
                                    <option key={product.id} value={product.id}>
                                        {product.company} {product.productName} ({product.unitOfMeasure})
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Quantity and Stock Info */}
                        <div className="flex space-x-4">
                            <div className="flex-1">
                                <label className="block text-sm font-medium text-gray-700">Quantity Needed</label>
                                <input
                                    type="number"
                                    min="1"
                                    max={currentStock || 1}
                                    value={quantity}
                                    onChange={(e) => setQuantity(e.target.value)}
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="Qty"
                                    disabled={!selectedProduct}
                                    required
                                />
                            </div>
                            <div className="flex-1">
                                <label className="block text-sm font-medium text-gray-700">Current Stock</label>
                                <p className={`mt-1 p-2 font-bold rounded-md ${currentStock > 0 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}`}>
                                    {currentStock} {selectedProduct && staffInventory.find(p => p.id === selectedProduct)?.unitOfMeasure}
                                </p>
                            </div>
                        </div>

                        {/* Purpose/Reason */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Purpose of Consumption</label>
                            <textarea
                                value={purpose}
                                onChange={(e) => setPurpose(e.target.value)}
                                rows="2"
                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="e.g., Full head application for client John Doe"
                                required
                            />
                        </div>

                        <Button type="submit" disabled={isSubmitting || currentStock <= 0 || !selectedProduct}>
                            {isSubmitting ? 'Submitting...' : 'Submit for Approval'}
                        </Button>
                    </form>
                </div>
            );
        });

        // Staff Sub-Component: Request History
        const StaffRequestHistory = ({ staffRequests, findProductById }) => {
            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">My Consumption Requests</h2>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {staffRequests.slice(0, 10).map(request => {
                                    const product = findProductById(request.productId);
                                    let statusClass = '';
                                    if (request.status === 'Pending') statusClass = 'bg-yellow-100 text-yellow-800';
                                    if (request.status === 'Approved') statusClass = 'bg-green-100 text-green-800';
                                    if (request.status === 'Rejected') statusClass = 'bg-red-100 text-red-800';

                                    return (
                                        <tr key={request.id}>
                                            <td className="py-3 px-3 whitespace-normal text-sm text-gray-600">
                                                {product ? getProductNameDisplay(product) : 'Product Not Found'}
                                            </td>
                                            <td className="py-3 px-3 whitespace-nowrap text-sm font-bold text-indigo-600">{request.quantityRequested}</td>
                                            <td className="py-3 px-3 whitespace-nowrap">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}`}>
                                                    {request.status}
                                                </span>
                                            </td>
                                            <td className="py-3 px-3 whitespace-nowrap text-sm text-gray-500">
                                                {new Date(request.requestTimestamp).toLocaleDateString()}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        <p className="mt-4 text-xs text-gray-500 italic">Showing latest {Math.min(10, staffRequests.length)} requests.</p>
                    </div>
                </div>
            );
        };

        // Staff Sub-Component: Branch Inventory Status
        const BranchInventoryStatus = ({ staffInventory, branchStock }) => {
            
            // Combine inventory details with current stock
            const statusData = useMemo(() => {
                return staffInventory.map(product => {
                    const stock = branchStock[product.id]?.currentStock || 0;
                    const isLow = stock <= product.lowStockThreshold;
                    const statusColor = isLow ? 'text-red-600' : 'text-green-600';

                    return {
                        id: product.id,
                        name: getProductNameDisplay(product),
                        stock: stock,
                        threshold: product.lowStockThreshold,
                        isLow: isLow,
                        statusColor: statusColor,
                    };
                }).sort((a, b) => b.isLow - a.isLow); // Sort by low stock first
            }, [staffInventory, branchStock]);

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg mt-8">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">My Branch Stock Levels</h2>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Threshold</th>
                                    <th className="py-3 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {statusData.map(item => (
                                    <tr key={item.id} className={item.isLow ? 'bg-red-50' : ''}>
                                        <td className="py-3 px-3 whitespace-normal text-sm font-medium text-gray-900">{item.name}</td>
                                        <td className={`py-3 px-3 whitespace-nowrap text-sm font-bold ${item.statusColor}`}>{item.stock}</td>
                                        <td className="py-3 px-3 whitespace-nowrap text-sm text-gray-500">{item.threshold}</td>
                                        <td className={`py-3 px-3 whitespace-nowrap text-xs font-semibold ${item.isLow ? 'text-red-700' : 'text-green-700'}`}>
                                            {item.isLow ? 'LOW' : 'OK'}
                                        
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };


        // --- RENDERING ---
        // FIX: Use createRoot for React 18 compatibility
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
</body>
</html>